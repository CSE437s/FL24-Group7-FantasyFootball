{% extends "base.html" %}

{% block title %}Trade Builder - Yahoo Fantasy Football MVP{% endblock %}

{% block content %}
<div class="container">
    <h1>Trade Builder</h1>
    <form method="POST" id="tradeForm">
        <label for="team1">Select team 1:</label>
        <select name="team1" id="team1">
            {% for team in teams %}
                <option value="{{ team }}" {% if team == request.form.team1 %}selected{% endif %}>{{ team }}</option>
            {% endfor %}
        </select>

        <label for="team2">Select team 2:</label>
        <select name="team2" id="team2">
            {% for team in teams %}
                <option value="{{ team }}" {% if team == request.form.team2 %}selected{% endif %}>{{ team }}</option>
            {% endfor %}
        </select>

        <button type="submit">Get Rosters</button>
    </form>

    {% if team1_roster and team2_roster %}
        <h2>{{ request.form.team1 }} Roster</h2>
        <form method="POST" id="tradeFormDetails" onsubmit="return confirmTrade()">
            <input type="hidden" name="team1" value="{{ request.form.team1 }}">
            <input type="hidden" name="team2" value="{{ request.form.team2 }}">

            <label for="your_players">Select players to trade:</label>
            <div id="your_players_container">
                <div class="player-select">
                    <div class="player-info-container">
                        <select name="your_players" class="your_players">
                            {% for player in team1_roster %}
                                <option value="{{ player[0] }}"
                                data-player-name="{{ player.Player }}" 
                                data-player-pos="{{ player.Pos }}"
                                data-player-headshot="{{ player.img }}" 
                                data-player-bye="{{ player.bye }}" 
                                data-player-ranking="{{ player.previous_performance }}" 
                                data-player-status="{{ player.status }}" 
                                data-player-injury="{{ player.injury }}" 
                                data-player-team="{{ player.team_abb }}" >{{ player.Player }} ({{ player.Pos }})</option>
                            {% endfor %}
                        </select>
                        <a href="#" class="info-icon" style="margin-left: 5px;">
                            <i class="fas fa-info-circle"></i>
                        </a>
                    </div>
                    <button type="button" class="removePlayerButton" onclick="removePlayer(this)">Remove Player</button>
                </div>
            </div>
            
            <button type="button" id="addYourPlayerButton">Add Another Player</button>

            <h2>{{ request.form.team2 }} Roster</h2>
            <label for="target_players">Select players to receive:</label>
            <div id="target_players_container">
                <div class="player-select">
                    <div class="player-info-container">
                        <select name="target_players" class="target_players">
                            {% for player in team2_roster %}
                            <option value="{{ player[0] }}"
                            data-player-name="{{ player.Player }}" 
                            data-player-pos="{{ player.Pos }}"
                            data-player-headshot="{{ player.img }}" 
                            data-player-bye="{{ player.bye }}" 
                            data-player-ranking="{{ player.previous_performance }}" 
                            data-player-status="{{ player.status }}" 
                            data-player-injury="{{ player.injury }}" 
                            data-player-team="{{ player.team_abb }}" >{{ player.Player }} ({{ player.Pos }})</option>
                            {% endfor %}
                        </select>
                        <a href="#" class="info-icon" style="margin-left: 5px;">
                            <i class="fas fa-info-circle"></i>
                        </a>
                    </div>
                    <button type="button" class="removePlayerButton" onclick="removePlayer(this)">Remove Player</button>
                </div>
            </div>
            <button type="button" id="addTargetPlayerButton">Add Another Player</button>

            <button type="submit" onclick="return confirmTrade()">Propose Trade</button>
        </form>

        <div id="section3">
            <h2>Proposed Trade</h2>
            <div id="tradeDetails" class="trade-summary-card"></div>
            <button type="button" onclick="return copyTrade()">Copy Trade Details</button>
            <button type="button" onclick="return restartTrade()">Restart Trade Builder</button>
        </div>

        {% if trade_feedback %}
            <h2>Proposed Trade</h2>
            <p>Your Trade: {{ trade_feedback }}</p>
        {% endif %}
    {% endif %}

</div>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

<script>
    $(document).ready(function() {

    // For initial Load
    function updateInfoIcons() {
        $('.your_players, .target_players').each(function() {
            const selectedOption = $(this).find('option:selected');
            const infoIcon = $(this).siblings('.info-icon');

            // Populate the info icon with player data
            infoIcon.data({
                playerName: selectedOption.data('player-name'),
                playerPos: selectedOption.data('player-pos'),
                playerHeadshot: selectedOption.data('player-headshot'),
                playerBye: selectedOption.data('player-bye'),
                playerRanking: selectedOption.data('player-ranking'),
                playerStatus: selectedOption.data('player-status'),
                playerInjury: selectedOption.data('player-injury'),
                playerTeam: selectedOption.data('player-team')
            });

            // Show the info icon
            infoIcon.show();
        });
    }

    updateInfoIcons();

    // Show info icon when player is selected
    $('.your_players, .target_players').change(function() {
        const selectedOption = $(this).find('option:selected');
        const infoIcon = $(this).siblings('.info-icon');

        // Populate the info icon with player data
        infoIcon.data({
            playerName: selectedOption.data('player-name'),
            playerPos: selectedOption.data('player-pos'),
            playerHeadshot: selectedOption.data('player-headshot'),
            playerBye: selectedOption.data('player-bye'),
            playerRanking: selectedOption.data('player-ranking'),
            playerStatus: selectedOption.data('player-status'),
            playerInjury: selectedOption.data('player-injury'),
            playerTeam: selectedOption.data('player-team')
        });

        // Show the info icon
        infoIcon.show();
    });

    // Info icon click handler
    $('.info-icon').on('click', function(event) {
        event.preventDefault();  // Prevent default link behavior
        const playerData = $(this).data();

        // Populate the dashboard with player data
        document.getElementById("dashboardPlayerName").innerText = playerData.playerName;
        document.getElementById("dashboardPlayerPosition").innerText = playerData.playerPos;
        document.getElementById("playerHeadshot").src = playerData.playerHeadshot;
        document.getElementById("playerTeam").innerText = playerData.playerTeam;
        document.getElementById("byeWeek").innerText = playerData.playerBye;
        document.getElementById("playerRanking").innerText = playerData.playerRanking;
        document.getElementById("injury").innerText = playerData.playerInjury;

        // Display the modal
        $('#playerDashboard').show();
    });

    // Close the dashboard when the close icon is clicked
    $('#closeDashboard').on('click', function() {
        $('#playerDashboard').hide();
    });

    $(window).on('click', function(event) {
        if ($(event.target).is('#playerDashboard')) {
            $('#playerDashboard').hide();
        }
    });
    });


    function removePlayer(button) {
        $(button).closest('.player-select').remove();
    }

    function confirmTrade() {
        event.preventDefault();
    //     var yourPlayers = [];
    //     var targetPlayers = [];

    //     $('select[name="your_players"]').each(function() {
    //         yourPlayers.push($(this).val());
    //     });

    //     $('select[name="target_players"]').each(function() {
    //         targetPlayers.push($(this).val());
    //     });

    //     var team1Name = $('input[name="team1"]').val();
    //     var team2Name = $('input[name="team2"]').val();

    //     var message = `
    //     <div class="team-section">
    //         <h4>${team1Name} trades:</h4>
    //         <ul class="player-list">
    //             ${yourPlayers.map(player => `<li>${player}</li>`).join('')}
    //         </ul>
    //     </div>
    //     <div class="team-section">
    //         <h4>${team2Name} trades:</h4>
    //         <ul class="player-list">
    //             ${targetPlayers.map(player => `<li>${player}</li>`).join('')}
    //         </ul>
    //     </div>
    // `;

    //     $('#tradeDetails').html(message);
    alert("Trade Confirmed!");
        return true;
    }

    function copyTrade() {
        // const tradeDetails = document.getElementById("tradeDetails");
        // if (!tradeDetails || tradeDetails.innerHTML.trim() === "") {
        //     alert("There are no trade details to copy.");
        //     return;
        // }

        // const tempTextArea = document.createElement("textarea");
        // tempTextArea.value = tradeDetails.innerText;
        // document.body.appendChild(tempTextArea);
        // tempTextArea.select();
        // document.execCommand("copy");
        // document.body.removeChild(tempTextArea);
        alert("Trade details copied to clipboard!");
    }

    function restartTrade() {
        document.getElementById("tradeDetails").innerHTML = "";
    }
</script>
{% endblock %}
